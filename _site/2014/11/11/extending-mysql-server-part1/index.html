<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
    MySQL .NET Hosting Extension - Part 1 - Compile Sample UDF &middot; Debug Things
    
  </title>
  <!--FONTS-->
  <link href='http://fonts.googleapis.com/css?family=Lato&subset=latin,latin-ext' rel='stylesheet' type='text/css'>


  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/monokai.css">
  <link rel="stylesheet" href="/public/css/bootstrap.css">
  <link rel="stylesheet" href="/public/css/poole.css">

  

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56527114-1', 'auto');
  ga('send', 'pageview');

</script>

</head>


<body>
  <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a href="/" class="navbar-brand" title="Home">DEBUG THINGS</a>
      </div>
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about/">About</a></li>
          <li><a href="/projects">Projects</a></li>
          <li><a href="/owasp/">OWASP Tampa</a></li>
        </ul>
      </div><!--/.navbar-collapse -->
    </div>
  </nav>
  <div class="container containerbg">
   <div class="row rowoffset">
    <div class="col-md-8">
      <div class="post">
  <h1 class="post-title">MySQL .NET Hosting Extension - Part 1 - Compile Sample UDF</h1>
  <span class="post-date">11 Nov 2014</span>
  <a href="https://twitter.com/share" class="twitter-share-button" data-via="debugthings" data-size="large">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  <p>So, the first thing I had to do was compile the MySQL sample UDF which is included in the source tree. While it seems like a simple thing to do with CMake and all of the proper tools installed, there are a few things not documented. The steps to compile <a href="http://dev.mysql.com/doc/refman/5.5/en/udf-compiling.html">can be found here</a>. The steps are really straight forward, but there is a catch. In order to build on Windows there are a few steps you will need to do in order to fully get the example working.</p>

<h2>Prerequisites</h2>

<ol>
<li><a href="http://dev.mysql.com/downloads/mysql/">The source files</a></li>
<li><a href="http://www.cmake.org/">CMake</a></li>
<li><a href="http://gnuwin32.sourceforge.net/packages/bison.htm">Bison</a></li>
<li><a href="http://msdn.microsoft.com/en-us/library/dd831853.aspx">Visual Studio 2013</a></li>
</ol>

<h2>Issues</h2>

<p>With the source tree downloaded I was able to get started. I unfortunately went the route of installing Bazaar and downloading the source. The easier&mdash;and better&mdash;way is to go <a href="http://dev.mysql.com/downloads/mysql/">here and download</a> the developer source; make sure you select <code>Source Code</code> from the drop down box.</p>

<p>After the source is downloaded, follow the <a href="http://dev.mysql.com/doc/refman/5.5/en/udf-compiling.html">UDF compile</a> instructions. Now, try it. Did it work? Probably not. You can try and update the <code>CMakeLists.txt</code> file to include extra directories, because it seems like it would help.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">cmake_minimum_required(VERSION 3.1)
PROJECT(udf_example)

# Path for MySQL include directory
INCLUDE_DIRECTORIES(&quot;C:/Users/James/Source/BazaarRepos/mysql-server/mysql-5.5/include&quot;)
INCLUDE_DIRECTORIES(&quot;C:/Users/James/Source/BazaarRepos/mysql-server/mysql-5.5/sql&quot;)
INCLUDE_DIRECTORIES(&quot;C:/Users/James/Source/BazaarRepos/mysql-server/mysql-5.5/regex&quot;)

ADD_DEFINITIONS(&quot;-DHAVE_DLOPEN&quot;)
ADD_LIBRARY(udf_example MODULE udf_example.c udf_example.def)
TARGET_LINK_LIBRARIES(udf_example wsock32)
</code></pre></div>
<p>Try again. Nope?</p>

<p>You may have seen an error like this: <code>include\my_global.h(77): fatal error C1083: Cannot open include file: &#39;my_config.h&#39;: No such file or directory</code>. This is pretty straight forward and says you don&rsquo;t have that file. But how do we get it?</p>

<p>What I found I had to do was do a <a href="http://dev.mysql.com/doc/internals/en/cmake-howto-detailed.html">full compile</a> of the MySQL source to generate all of the proper libraries and to generate a few configuration header files. In hind sight if I had found that article before starting with the UDF I would have gotten a lot further.</p>

<p>However, there is still a gotcha here. When compiling <code>mysqld.exe</code> you may get an error that looks like this <code>error LNK2001: unresolved external symbol _xmm@0000001100000010000000050000000f</code>. Apparently when you compile with debug symbols a few compiler intrinsics make it through the <code>create_def_file.js</code> CScript file. In order to fix this you can alter the <code>IsCompilerDefinedSymbol()</code> method in the CScript file to look like below. This removes any instance of XMM that is generated in the DEF file.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// returns true if the symbol is compiler defined</span>
<span class="kd">function</span> <span class="nx">IsCompilerDefinedSymbol</span><span class="p">(</span><span class="nx">symbol</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">((</span><span class="nx">symbol</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;__real@&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
    <span class="p">(</span><span class="nx">symbol</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;_RTC_&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span> 
    <span class="p">(</span><span class="nx">symbol</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;??_C@_&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
    <span class="p">(</span><span class="nx">symbol</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;??_R&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
    <span class="p">(</span><span class="nx">symbol</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;??_7&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="o">||</span>
    <span class="p">(</span><span class="nx">symbol</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;?_G&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>           <span class="c1">// scalar deleting destructor</span>
    <span class="p">(</span><span class="nx">symbol</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;_VInfreq_?&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>    <span class="c1">// special label (exception handler?) for Intel compiler</span>
    <span class="p">(</span><span class="nx">symbol</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;?_E&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>           <span class="c1">// vector deleting destructor</span>
    <span class="p">(</span><span class="nx">symbol</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;_xmm&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">||</span>           <span class="c1">// Compiler XMM intrinsic</span>
    <span class="p">(</span><span class="nx">symbol</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;__xmm&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>          <span class="c1">// Compiler XMM intrinsic</span>
<span class="p">}</span>
</code></pre></div>
<p>After this change I was able to run the following command <code>devenv MySQL.sln /build RelWithDebInfo &gt; output_build.txt</code> to generate all of the files I needed.</p>

<p>Once I had the binaries compiled and all of the headers I needed I attempted to create a standalone project again. This time I only received one error.
<code>1&gt;udf_example.obj : error LNK2019: unresolved external symbol _stpcpy referenced in function _avgcost_init</code>. </p>

<p>In order to fix this I made a quick change to a line of code in the <code>udf_example.c</code> file. The proper way would have been to include the strings library that was generated from the full compile but I didn&rsquo;t want to fuss with it completely.</p>
<div class="highlight"><pre><code class="language-C" data-lang="C"><span class="c1">// udf_example.c - Lines removed for brevity</span>

<span class="cm">/* BEFORE */</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#define strmov(a,b) stpcpy(a,b)</span>
<span class="cp">#define bzero(a,b) memset(a,0,b)</span>
<span class="cp">#endif</span>

<span class="cm">/* AFTER CODE CHANGE */</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#define strmov(a,b) strcpy(a,b)</span>
<span class="cp">#define bzero(a,b) memset(a,0,b)</span>
<span class="cp">#endif</span>
</code></pre></div>
<p>Now the application will compile! At least it did for me. If you want to check you can either install it using the instructions from the compile link above or just execute the <code>&lt;root&gt;\sql\RelWithDebInfo\mysqld.exe</code>.</p>

<h2>Results</h2>

<p>I compiled and renamed the UDF example to myudf.dll. I was able to load this hello world function into MySQL using the <code>CREATE FUNCTION</code> command.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; CREATE FUNCTION myfunc_double RETURNS REAL SONAME &quot;myudf.dll&quot;;
Query OK, 0 rows affected (0.01 sec)

mysql&gt; SELECT myfunc_double(1.2);
+--------------------+
| myfunc_double(1.2) |
+--------------------+
|              48.33 |
+--------------------+
1 row in set (0.00 sec)

mysql&gt; SELECT myfunc_double(22);
+-------------------+
| myfunc_double(22) |
+-------------------+
|             50.00 |
+-------------------+
1 row in set (0.00 sec)

mysql&gt; SELECT myfunc_double(10000);
+----------------------+
| myfunc_double(10000) |
+----------------------+
|                48.20 |
+----------------------+
1 row in set (0.00 sec)

mysql&gt; SELECT myfunc_double(10000);
+----------------------+
| myfunc_double(10000) |
+----------------------+
|                48.20 |
+----------------------+
1 row in set (0.00 sec)

mysql&gt; SELECT myfunc_double(10000);
+----------------------+
| myfunc_double(10000) |
+----------------------+
|                48.20 |
+----------------------+
1 row in set (0.00 sec)

mysql&gt;
</code></pre></div>
</div>

 <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'debugthings'; // required: replace example with your forum shortname
        var disqus_url = 'http://www.debugthings.com/2014/11/11/extending-mysql-server-part1/';
        var disqus_identifier = '/2014/11/11/extending-mysql-server-part1';


        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
    <li>
      <h3>
        <a href="/2014/11/16/extending-mysql-server-part2/">
          MySQL .NET Hosting Extension - Part 2 - UDF Deep Dive
          <small>16 Nov 2014</small>
        </a>
      </h3>
    </li>
    
    <li>
      <h3>
        <a href="/2014/11/11/extending-mysql-server-part0/">
          MySQL .NET Hosting Extension - Part 0
          <small>11 Nov 2014</small>
        </a>
      </h3>
    </li>
    
    <li>
      <h3>
        <a href="/2014/11/06/owasp-top-10-mvc-tampa-day-talk/">
          First Time Speaking at OWASP Tampa
          <small>06 Nov 2014</small>
        </a>
      </h3>
    </li>
    
  </ul>
</div>

      <div class="footer">
        <p>
          &copy; 2014. All rights reserved.
        </p>
      </div>
    </div>
    <div class="col-md-3 col-md-offset-1 hidden-xs hidden-sm" >
      <div class="well">
        <h3>About</h3>
        <p>
          This blog is dedicated to a number of topics. Honestly it's what ever I feel like talking about on any given day. Topics will most always be tech related some how. Major themes will be low level debugging, .NET hacking, DevOps, and programming.
        </p>
        <p>
          All thoughts and opinions on this blog are my own.
        </p>
        <div style="display: flex; padding-top: 0.5em">
          <a href="http://www.linkedin.com/in/debugthings/"><img src="https://dlc1-s.licdn.com/sites/default/files/InBug-60px-R.png" class="linked" /></a>
          <a href="http://www.twitter.com/debugthings"><div class="twitbox"><img src="https://g.twimg.com/Twitter_logo_white.png" /></div><span>@debugthings</span></a>
        </div>  
      </div>
      <div>

      </div>
    </div>
  </div>
</div>


</body>
</html>
